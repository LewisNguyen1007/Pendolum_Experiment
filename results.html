<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Experiment Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Đảm bảo khu vực chart luôn có chiều cao để Chart.js render ổn định */
    #chartWrap { height: 420px; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
  <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Experiment Results</h1>

    <!-- Filters -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <div class="flex-1">
        <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-2">Select date:</label>
        <select id="dateFilter" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="all">All dates</option>
        </select>
      </div>

      <div class="flex-1">
        <label for="sessionFilter" class="block text-sm font-medium text-gray-700 mb-2">Select session:</label>
        <select id="sessionFilter" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="1">Session 1</option>
          <option value="2">Session 2</option>
        </select>
      </div>
    </div>

    <div id="loadingMessage" class="text-center text-gray-600 p-8">Loading data...</div>

    <div id="chartWrap" class="w-full">
      <!-- canvas sẽ được tạo lại mỗi lần update -->
      <canvas id="histogramChart"></canvas>
    </div>
  </div>

  <script>
    // URL Web App mới của bạn
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBu-y0zNvyBVdYFnt30vEwhvARMVYwoVmwDbxPtxwqZxzLjxiky4YFkRgpvZF9che6/exec";

    const dateFilter     = document.getElementById('dateFilter');
    const sessionFilter  = document.getElementById('sessionFilter');
    const loadingMessage = document.getElementById('loadingMessage');
    const chartWrap      = document.getElementById('chartWrap');

    let allData  = [];
    let dataReady = false;

    // Cột (0-indexed) theo Code.gs: [UserID, Answer, Session, Timestamp, Date]
    const COL_ANSWER  = 1;
    const COL_SESSION = 2;
    const COL_DATE    = 4;

    async function fetchData() {
      try {
        const url = `${SCRIPT_URL}?t=${Date.now()}`; // tránh cache
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("Invalid data shape from server.");

        allData = data;
        dataReady = true;

        populateDateFilter();
        loadingMessage.style.display = 'none';
        updateChart(); // render lần đầu

      } catch (err) {
        console.error(err);
        loadingMessage.textContent = "Could not load data. Please check the script deployment & permissions.";
        loadingMessage.className = "text-center text-red-600 p-8";
      }
    }

    function populateDateFilter() {
      const dates = [...new Set(allData.map(r => r[COL_DATE]).filter(Boolean))];
      // sort theo thời gian (dd/MM/yyyy → yyyy-MM-dd), mới nhất trước
      dates.sort((a, b) => {
        const pa = a.split('/').reverse().join('-');
        const pb = b.split('/').reverse().join('-');
        return (pa < pb) ? 1 : (pa > pb ? -1 : 0);
      });

      while (dateFilter.options.length > 1) dateFilter.remove(1);
      for (const d of dates) {
        const op = document.createElement('option');
        op.value = d;
        op.textContent = d;
        dateFilter.appendChild(op);
      }
    }

    function renderChart(counts, sessionLabel, dateLabel) {
      // Xóa chart cũ bằng cách thay canvas mới để tránh lỗi destroy/context
      const oldCanvas = document.getElementById('histogramChart');
      if (oldCanvas) oldCanvas.remove();
      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'histogramChart';
      chartWrap.appendChild(newCanvas);

      const labels = Array.from({ length: 30 }, (_, i) => String(i + 1));
      const ctx = newCanvas.getContext('2d');

      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: `Number of answers (Session ${sessionLabel} - ${dateLabel})`,
            data: counts,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            borderRadius: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Number of respondents' },
              ticks: { stepSize: 1 }
            },
            x: {
              title: { display: true, text: 'Answer value (number of oscillations)' }
            }
          },
          plugins: {
            legend: { display: true, position: 'top' }
          }
        }
      });
    }

    function updateChart() {
      if (!dataReady) return;

      const selectedDate    = dateFilter.value;
      const selectedSession = sessionFilter.value;

      const filtered = allData.filter(row => {
        const okDate    = (selectedDate === 'all' || row[COL_DATE] === selectedDate);
        const okSession = String(row[COL_SESSION]) === String(selectedSession);
        return okDate && okSession;
      });

      const counts = new Array(30).fill(0);
      for (const row of filtered) {
        const ans = parseInt(row[COL_ANSWER], 10);
        if (Number.isFinite(ans) && ans >= 1 && ans <= 30) counts[ans - 1]++;
      }

      // Nếu không có dữ liệu, hiển thị thông báo thay vì "mất bảng"
      const total = counts.reduce((a, b) => a + b, 0);
      if (total === 0) {
        loadingMessage.textContent = "No data for selected filters.";
        loadingMessage.className = "text-center text-gray-500 p-4";
        loadingMessage.style.display = 'block';
      } else {
        loadingMessage.style.display = 'none';
      }

      // Luôn render chart (kể cả toàn số 0) để giữ trục hiển thị ổn định
      renderChart(counts, selectedSession, (selectedDate === 'all' ? 'All dates' : selectedDate));
    }

    // Init
    window.onload = () => {
      // gắn listener trước, nhưng updateChart có guard dataReady
      dateFilter.addEventListener('change', updateChart);
      sessionFilter.addEventListener('change', updateChart);

      fetchData();
    };
  </script>
</body>
</html>
